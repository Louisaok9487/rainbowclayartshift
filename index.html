<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Shift Scheduler</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base Dark Theme - Using richer slate tones */
        html { font-family: "Inter", sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #6366f1; /* Indigo-500 */ border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: #1e293b; /* Slate-800 */ }
        
        /* Mobile specific adjustments for calendar */
        @media (max-width: 640px) {
            .shift-entry {
                padding: 0.25rem !important;
                font-size: 0.6rem !important;
            }
            .h-28 { height: 7.5rem; }
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto">
        <header class="mb-8 text-center relative">
            <h1 class="text-4xl font-extrabold text-indigo-400">Team Shift Rota</h1>
            <p class="mt-2 text-gray-400 text-sm sm:text-base">View available shifts and sign up in real-time. 
                <span class="inline-block mt-1 sm:mt-0">
                    <span id="user-role-label" class="font-semibold text-xs">Role: Loading...</span> | 
                    User ID: <span id="user-id" class="font-mono text-xs bg-slate-800 p-1 rounded">Loading...</span>
                </span>
            </p>
            
            <!-- Admin Login Button (Moved to top-right corner) -->
            <button id="open-admin-login" class="absolute top-0 right-0 p-3 rounded-full bg-slate-700 hover:bg-slate-600 transition duration-150 shadow-lg" title="Admin Login">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6-4h12m-6-4h.01M12 12a2 2 0 100-4 2 2 0 000 4zm7-4h1a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h1M4 16v-4h16v4"/>
                </svg>
            </button>

        </header>

        <!-- Calendar Navigation and Controls -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 p-4 bg-slate-800 rounded-2xl shadow-xl">
            <div class="flex space-x-4 mb-4 sm:mb-0">
                <button id="prev-month" class="p-2 rounded-full bg-indigo-600 hover:bg-indigo-500 transition duration-150 shadow-md">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button id="next-month" class="p-2 rounded-full bg-indigo-600 hover:bg-indigo-500 transition duration-150 shadow-md">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <h2 id="current-month-year" class="text-xl sm:text-2xl font-semibold text-white"></h2>
            
            <!-- Add Shift Button (Visibility controlled by admin status) -->
            <button id="open-shift-modal" class="mt-4 sm:mt-0 px-6 py-2 bg-green-600 hover:bg-green-500 rounded-xl font-medium shadow-md transition duration-150 text-sm sm:text-base hidden">
                + Add New Shift
            </button>
        </div>

        <!-- Calendar Grid -->
        <div class="bg-slate-800 p-2 sm:p-4 rounded-2xl shadow-2xl">
            <div class="grid grid-cols-7 text-center font-bold text-xs sm:text-sm mb-2 text-indigo-300">
                <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span class="text-red-400">Sat</span><span class="text-red-400">Sun</span>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1 custom-scroll" style="min-height: 400px;">
                <!-- Calendar Days will be inserted here by JavaScript -->
            </div>
        </div>

        <!-- Shifts Detail/Sign-up/Cancellation Modal -->
        <div id="shift-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-md transform transition-all">
                <h3 id="modal-title" class="text-2xl font-bold mb-4 text-white">Shift Details</h3>
                <div id="modal-shift-info" class="mb-4">
                    <!-- Shift details populated here -->
                </div>
                
                <!-- Sign-up List and Slots Count -->
                <div id="filled-info-container" class="space-y-4 hidden">
                    <p class="text-lg text-indigo-400 font-semibold">Current Sign-Ups (<span id="slots-count"></span>):</p>
                    <ul id="signed-up-list" class="space-y-2 max-h-40 overflow-y-auto custom-scroll">
                        <!-- List of sign-ups populated here -->
                    </ul>
                </div>
                <!-- END NEW -->

                <div id="signup-form-container" class="space-y-4 pt-4">
                    <input type="text" id="signup-name" placeholder="Your Name" class="w-full p-3 bg-slate-700 rounded-xl border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                    <button id="sign-up-button" class="w-full p-3 bg-green-600 hover:bg-green-500 rounded-xl font-bold transition duration-150 shadow-lg">Sign Up for this Shift</button>
                </div>

                <!-- Messages and Action Buttons -->
                <p id="can-cancel-message" class="text-sm text-red-400 mb-4 hidden"></p>

                <div class="pt-4 space-y-3">
                    <button id="cancel-sign-up-button" class="w-full p-3 bg-red-600 hover:bg-red-500 rounded-xl font-bold transition duration-150 hidden shadow-lg">Cancel My Sign-Up</button>
                    <!-- Admin action to clear ALL sign-ups -->
                    <button id="super-cancel-button" class="w-full p-3 bg-red-700 hover:bg-red-600 rounded-xl font-bold transition duration-150 hidden shadow-lg"></button> 
                    <!-- Admin action to delete shift entirely -->
                    <button id="admin-delete-button" class="w-full p-3 bg-slate-600 hover:bg-slate-500 rounded-xl font-bold transition duration-150 hidden shadow-lg">Admin: Delete Shift Completely</button>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="close-detail-modal" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-xl font-medium">Close</button>
                </div>
            </div>
        </div>

        <!-- Add New Shift Modal (Admin Tool) -->
        <div id="add-shift-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-lg transform transition-all">
                <h3 class="text-2xl font-bold mb-4 text-indigo-400">Schedule New Shift</h3>
                <form id="add-shift-form" class="space-y-4">
                    <!-- Date Input -->
                    <label for="shift-date" class="block text-sm font-medium text-gray-300">Date</label>
                    <input type="date" id="shift-date" class="w-full p-3 bg-slate-700 rounded-xl border border-slate-600 text-white" required>
                    
                    <!-- NEW: Slots Input -->
                    <label for="shift-slots" class="block text-sm font-medium text-gray-300">Number of Slots</label>
                    <input type="number" id="shift-slots" min="1" value="1" class="w-full p-3 bg-slate-700 rounded-xl border border-slate-600 text-white" required>
                    
                    <!-- Time Dropdowns -->
                    <label class="block text-sm font-medium text-gray-300">Shift Time</label>
                    <div class="flex space-x-4">
                        <select id="shift-start-time" class="w-1/2 p-3 bg-slate-700 rounded-xl border border-slate-600 text-white" required>
                            <option value="" disabled selected>Start Time</option>
                        </select>
                        <select id="shift-end-time" class="w-1/2 p-3 bg-slate-700 rounded-xl border border-slate-600 text-white" required>
                            <option value="" disabled selected>End Time</option>
                        </select>
                    </div>

                    <!-- Role Input -->
                    <label for="shift-role" class="block text-sm font-medium text-gray-300">Role / Description</label>
                    <input type="text" id="shift-role" placeholder="e.g., Weekend Cashier" class="w-full p-3 bg-slate-700 rounded-xl border border-slate-600 text-white" required>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="close-add-modal" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-xl font-medium">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-medium shadow-md">Create Shift</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Login Modal -->
        <div id="admin-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all">
                <h3 class="text-2xl font-bold mb-4 text-indigo-400">Admin Login</h3>
                <p id="admin-status-message" class="text-sm text-red-400 mb-4 hidden">Invalid credentials. Please try again.</p>
                <form id="admin-login-form" class="space-y-4">
                    <!-- Placeholder text removed here -->
                    <input type="text" id="admin-username" placeholder="Username" class="w-full p-3 bg-slate-700 rounded-xl border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                    <!-- Placeholder text removed here -->
                    <input type="password" id="admin-password" placeholder="Password" class="w-full p-3 bg-slate-700 rounded-xl border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-admin-modal" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-xl font-medium">Cancel</button>
                        <button type="submit" id="login-button" class="px-6 py-2 bg-green-600 hover:bg-green-500 rounded-xl font-medium shadow-md">Login</button>
                        <button type="button" id="logout-button" class="px-6 py-2 bg-red-600 hover:bg-red-500 rounded-xl font-medium shadow-md hidden">Logout</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // IMPORT UPDATE: Added setLogLevel
        import { getFirestore, doc, updateDoc, deleteDoc, onSnapshot, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // This is the user-provided Firebase configuration.
        const providedConfigString = '{"apiKey": "AIzaSyBzGuxM-WXRFzkSLY16sutBF6qn57-tlsM", "authDomain": "rcashift-2e40d.firebaseapp.com", "projectId": "rcashift-2e40d", "storageBucket": "rcashift-2e40d.firebasestorage.app", "messagingSenderId": "903668836399", "appId": "1:903668836399:web:ed5e464cc9264847763eda"}';

        let firebaseConfig;
        try {
            // Use the environment variable if available, otherwise use the provided hardcoded configuration.
            const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : providedConfigString;
            firebaseConfig = JSON.parse(configString);
        } catch (e) {
            console.error("[CONFIG ERROR] Failed to parse Firebase configuration:", e);
            // Fallback to a blank object or handle the error gracefully
            firebaseConfig = {}; 
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- ADMIN CONFIGURATION (Hardcoded for local login) ---
        // Default admin credentials: Username (1234), Password (1234)
        let isAdmin = localStorage.getItem('isAdmin') === 'true'; // Persist admin status
        const ADMIN_USERNAME = '1234';
        const ADMIN_PASSWORD = '1234';
        

        let db;
        let auth;
        let currentUserId = null;
        let shiftsData = {}; 

        // Calendar state
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Elements
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const userIdEl = document.getElementById('user-id');
        const userRoleLabel = document.getElementById('user-role-label');
        

        // Modals
        const detailModal = document.getElementById('shift-detail-modal');
        const addModal = document.getElementById('add-shift-modal');
        const openShiftModalBtn = document.getElementById('open-shift-modal');
        const closeDetailModalBtn = document.getElementById('close-detail-modal');
        const closeAddModalBtn = document.getElementById('close-add-modal');
        const adminLoginModal = document.getElementById('admin-login-modal');

        // Modal elements (for shift details)
        const modalTitle = document.getElementById('modal-title');
        const modalShiftInfo = document.getElementById('modal-shift-info');
        const signupFormContainer = document.getElementById('signup-form-container');
        const filledInfoContainer = document.getElementById('filled-info-container');
        const signUpNameInput = document.getElementById('signup-name');
        const signUpButton = document.getElementById('sign-up-button');
        const cancelSignUpButton = document.getElementById('cancel-sign-up-button');
        const superCancelButton = document.getElementById('super-cancel-button'); 
        const adminDeleteButton = document.getElementById('admin-delete-button'); 
        
        // NEW: Multi-slot elements
        const slotsCountEl = document.getElementById('slots-count');
        const signedUpListEl = document.getElementById('signed-up-list');


        // Form elements (for adding shifts)
        const addShiftForm = document.getElementById('add-shift-form');
        const shiftDateInput = document.getElementById('shift-date');
        const shiftSlotsInput = document.getElementById('shift-slots'); // NEW
        const shiftStartTimeSelect = document.getElementById('shift-start-time');
        const shiftEndTimeSelect = document.getElementById('shift-end-time');

        // Admin Login elements
        const openAdminLoginBtn = document.getElementById('open-admin-login');
        const closeAdminModalBtn = document.getElementById('close-admin-modal');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminUsernameInput = document.getElementById('admin-username');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminStatusMessage = document.getElementById('admin-status-message');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');

        // --- FIREBASE INITIALISATION & AUTHENTICATION ---
        // Only attempt to initialize if a config object was successfully created
        if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
             try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // DEBUG: Set Firestore log level to debug for connectivity tracing
                setLogLevel('debug'); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdEl.textContent = currentUserId;
                        console.log(`[AUTH SUCCESS] User signed in. UID: ${currentUserId}.`); // DEBUG
                        
                        // Update UI elements based on local isAdmin state
                        updateAdminUI();

                        setupFirestoreListener();
                    } else {
                        console.log("[AUTH INFO] User not yet signed in. Attempting anonymous/custom token sign in."); // DEBUG
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (e) {
                                console.error("[AUTH ERROR] Failed to sign in with custom token, falling back to anonymous:", e);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("[FIREBASE INIT ERROR] Error during Firebase Initialisation:", error);
                userIdEl.textContent = "Error";
                userRoleLabel.textContent = "Role: Unknown";
            }
        } else {
            console.error("[FIREBASE INIT ERROR] Firebase config is missing or invalid. Cannot initialize.");
            userIdEl.textContent = "Config Error";
            userRoleLabel.textContent = "Role: Unknown";
        }


        // --- ADMIN LOGIN LOGIC ---
        function updateAdminUI() {
            // Update the global isAdmin state from local storage
            isAdmin = localStorage.getItem('isAdmin') === 'true';

            userRoleLabel.textContent = isAdmin ? "Role: Admin" : "Role: User";
            openShiftModalBtn.classList.toggle('hidden', !isAdmin);

            // Update login/logout buttons in the modal
            loginButton.classList.toggle('hidden', isAdmin);
            logoutButton.classList.toggle('hidden', !isAdmin);

            // Re-render calendar to update admin controls on existing shifts
            if (shiftsData) {
                renderCalendar();
            }
        }

        function openAdminLoginModal() {
            // Reset message
            adminStatusMessage.classList.add('hidden');
            
            // Set initial state of buttons
            loginButton.classList.toggle('hidden', isAdmin);
            logoutButton.classList.toggle('hidden', !isAdmin);

            adminLoginModal.classList.remove('hidden');
            adminLoginModal.classList.add('flex');
        }

        function closeAdminLoginModal() {
            adminLoginModal.classList.add('hidden');
            adminLoginModal.classList.remove('flex');
            adminLoginForm.reset();
        }

        function handleAdminLogin(e) {
            e.preventDefault();
            const username = adminUsernameInput.value.trim();
            // FIX: Removed the unnecessary `.input` property
            const password = adminPasswordInput.value.trim(); 

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                localStorage.setItem('isAdmin', 'true');
                showMessage("Admin login successful!");
                closeAdminLoginModal();
                updateAdminUI(); 
            } else {
                adminStatusMessage.textContent = "Invalid credentials. Please try again.";
                adminStatusMessage.classList.remove('hidden');
            }
        }

        function handleAdminLogout() {
            localStorage.setItem('isAdmin', 'false');
            showMessage("Logged out as Admin.");
            updateAdminUI();
            closeAdminLoginModal();
        }


        // --- UTILITY FUNCTIONS ---
        function formatDate(year, month, day) {
            const monthStr = String(month + 1).padStart(2, '0');
            const dayStr = String(day).padStart(2, '0');
            return `${year}-${monthStr}-${dayStr}`;
        }

        function generateTimeOptions() {
            let options = '';
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    options += `<option value="${time}">${time}</option>`;
                }
            }
            options += `<option value="23:59">23:59</option>`;
            return options;
        }

        function setTimeDropdowns() {
            const timeOptions = generateTimeOptions();
            shiftStartTimeSelect.innerHTML = `<option value="" disabled selected>Start Time</option>` + timeOptions;
            shiftEndTimeSelect.innerHTML = `<option value="" disabled selected>End Time</option>` + timeOptions;
        }

        // Custom alert function to avoid window.alert
        function showMessage(message, isError = false) {
            const modalId = isError ? 'error-modal' : 'message-modal';
            let modal = document.getElementById(modalId);

            if (!modal) {
                // Create a basic modal if it doesn't exist (simplified for this example)
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-[100]';
                modal.innerHTML = `
                    <div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
                        <p id="${modalId}-text" class="text-lg font-medium mb-4 ${isError ? 'text-red-400' : 'text-indigo-400'}"></p>
                        <div class="flex justify-end">
                            <button onclick="document.getElementById('${modalId}').classList.add('hidden'); document.getElementById('${modalId}').classList.remove('flex');" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-xl font-medium">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById(`${modalId}-text`).textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }


        // --- FIRESTORE FUNCTIONS ---

        function getCollectionRef() {
            // Path: /artifacts/{appId}/public/data/shifts
            const collectionPath = `artifacts/${appId}/public/data/shifts`;
            console.log(`[FIRESTORE INFO] Using collection path: ${collectionPath}`); // DEBUG
            return collection(db, collectionPath);
        }

        function setupFirestoreListener() {
            if (!db || !currentUserId) return;
            const shiftsRef = getCollectionRef();

            onSnapshot(shiftsRef, (snapshot) => {
                shiftsData = {}; 
                snapshot.forEach((doc) => {
                    const shift = { ...doc.data(), id: doc.id };
                    const dateKey = shift.date; 
                    // Ensure signUps is an array, defaulting to empty array if undefined/null
                    shift.signUps = Array.isArray(shift.signUps) ? shift.signUps : []; 
                    
                    if (!shiftsData[dateKey]) {
                        shiftsData[dateKey] = [];
                    }
                    shiftsData[dateKey].push(shift);
                });
                renderCalendar();
            }, (error) => {
                console.error("[FIRESTORE LISTENER ERROR] Error listening to shifts:", error);
                showMessage("Could not load shifts. Check console for details.", true);
            });
        }

        async function createShift(date, time, role, totalSlots) {
            if (!db || !currentUserId) { // Check if Firestore and Auth are ready
                showMessage("Cannot create shift: User not authenticated or database not connected.", true);
                console.error("[FIRESTORE ERROR] DB or Auth not ready during createShift attempt.");
                return false;
            }
            if (!isAdmin) {
                showMessage("Permission denied: Only Admin users can create shifts.", true);
                return false;
            }
            try {
                const shiftData = {
                    date: date,
                    time: time, 
                    role: role,
                    totalSlots: Number(totalSlots) > 0 ? Number(totalSlots) : 1, // NEW: Ensure at least 1 slot
                    signUps: [], // NEW: Use array to track multiple users
                    createdBy: currentUserId, // Track creator
                    createdAt: new Date().toISOString()
                };
                await addDoc(getCollectionRef(), shiftData);
                console.log(`[FIRESTORE SUCCESS] Shift created successfully in path: ${getCollectionRef().path}`); // DEBUG
                showMessage("Shift created successfully!");
                return true;
            } catch (error) {
                console.error("[FIRESTORE ERROR] Error creating shift:", error); // Enhanced Log
                showMessage("Failed to create shift. See console.", true);
                return false;
            }
        }

        async function deleteShift(shiftId) {
            if (!isAdmin) {
                showMessage("Permission denied: Only Admin users can delete shifts.", true);
                return false;
            }
            try {
                const shiftDocRef = doc(getCollectionRef(), shiftId);
                await deleteDoc(shiftDocRef);
                console.log(`[FIRESTORE SUCCESS] Shift ${shiftId} deleted.`); // DEBUG
                showMessage(`Shift deleted successfully!`);
                return true;
            } catch (error) {
                console.error("[FIRESTORE ERROR] Error deleting shift:", error);
                showMessage("Failed to delete shift. See console.", true);
                return false;
            }
        }

        async function signUpForShift(shiftId, name) {
            if (!db || !currentUserId) {
                showMessage("Cannot sign up: User not authenticated or database not connected.", true);
                return false;
            }

            try {
                const shiftDocRef = doc(getCollectionRef(), shiftId);
                
                // 1. Get current shift data to check for slots
                const currentShift = Object.values(shiftsData).flat().find(s => s.id === shiftId);
                if (!currentShift) {
                    showMessage("Shift not found or invalid ID.", true);
                    return false;
                }
                
                const currentSignUps = currentShift.signUps || [];

                // Check if slots are available
                if (currentSignUps.length >= currentShift.totalSlots) {
                     showMessage("Sorry, this shift is already fully booked.", true);
                     return false;
                }

                // Check if user is already signed up (prevents multi-sign-up by same user)
                if (currentSignUps.some(s => s.userId === currentUserId)) {
                    showMessage("You are already signed up for this shift.", true);
                    return false;
                }
                
                // Add new signup object
                const newSignUp = {
                    name: name,
                    userId: currentUserId,
                    signupId: crypto.randomUUID(), // Unique ID for targeting this specific signup
                    signedUpAt: new Date().toISOString()
                };

                await updateDoc(shiftDocRef, {
                    signUps: [...currentSignUps, newSignUp],
                });
                console.log(`[FIRESTORE SUCCESS] User ${currentUserId} signed up for shift ${shiftId}.`); // DEBUG
                showMessage(`Successfully signed up as ${name}!`);
                return true;
            } catch (error) {
                console.error("[FIRESTORE ERROR] Error signing up:", error);
                showMessage("Failed to sign up for shift. See console.", true);
                return false;
            }
        }

        // New function to clear a specific user's sign-up
        async function cancelUserSignUp(shiftId, signupId) { 
            if (!db || !currentUserId) {
                showMessage("Cannot cancel: User not authenticated or database not connected.", true);
                return false;
            }
            try {
                const shiftDocRef = doc(getCollectionRef(), shiftId);
                const currentShift = Object.values(shiftsData).flat().find(s => s.id === shiftId);

                if (!currentShift) return false;
                
                // Filter out the specific signup using its unique ID
                const updatedSignUps = (currentShift.signUps || []).filter(signup => signup.signupId !== signupId);

                await updateDoc(shiftDocRef, {
                    signUps: updatedSignUps,
                });
                console.log(`[FIRESTORE SUCCESS] User ${currentUserId} cancelled signup on shift ${shiftId}.`); // DEBUG
                showMessage(`Sign-up successfully cancelled.`);
                return true;
            } catch (error) {
                console.error("[FIRESTORE ERROR] Error cancelling sign up:", error);
                showMessage("Failed to cancel sign-up. See console.", true);
                return false;
            }
        }
        
        // New Admin function to clear all sign-ups
        async function adminClearAllSignUps(shiftId) {
            if (!isAdmin) {
                showMessage("Permission denied.", true);
                return false;
            }
            try {
                const shiftDocRef = doc(getCollectionRef(), shiftId);
                await updateDoc(shiftDocRef, {
                    signUps: [],
                });
                console.log(`[FIRESTORE SUCCESS] Admin cleared all signups on shift ${shiftId}.`); // DEBUG
                showMessage(`Admin: All sign-ups cleared for this shift.`);
                return true;
            } catch (error) {
                console.error("[FIRESTORE ERROR] Error clearing all sign ups:", error);
                showMessage("Failed to clear all sign-ups. See console.", true);
                return false;
            }
        }


        // --- CALENDAR LOGIC & RENDERING ---

        function getFirstDayOfMonth(year, month) {
            const date = new Date(year, month, 1);
            let day = date.getDay();
            return day === 0 ? 6 : day - 1; // Convert to Mon=0, Sun=6
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function renderCalendar() {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];

            currentMonthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            calendarGrid.innerHTML = ''; 

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const firstDayIndex = getFirstDayOfMonth(currentYear, currentMonth);

            for (let i = 0; i < firstDayIndex; i++) {
                const emptyCell = document.createElement('div');
                calendarGrid.appendChild(emptyCell);
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = formatDate(currentYear, currentMonth, day);
                const dayDate = new Date(currentYear, currentMonth, day);
                dayDate.setHours(0, 0, 0, 0); 
                
                const isToday = dayDate.getTime() === today.getTime();
                const isPast = dayDate < today; 
                
                const shiftsOnDay = shiftsData[dateKey] || [];

                const cell = document.createElement('div');
                cell.className = `p-2 sm:p-3 rounded-xl border border-gray-700 h-28 relative transition duration-150 overflow-y-auto custom-scroll`;
                
                if (isPast) {
                    cell.classList.add('bg-slate-900', 'text-gray-600', 'cursor-not-allowed', 'opacity-60');
                    cell.classList.remove('bg-slate-700', 'hover:bg-slate-600', 'cursor-pointer');
                } else {
                    // Applied richer colours for active cells
                    cell.classList.add('bg-slate-700', 'hover:bg-slate-600', 'cursor-pointer', 'text-gray-100');
                }
                
                if (isToday) {
                    cell.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2', 'ring-offset-slate-900');
                }

                cell.innerHTML = `
                    <div class="text-xl font-extrabold mb-1">${day}</div>
                    <div class="text-xs space-y-1">
                        ${shiftsOnDay.map(shift => {
                            const currentSignUps = (shift.signUps || []).length;
                            const totalSlots = shift.totalSlots || 1;
                            const isFull = currentSignUps >= totalSlots;
                            const userIsSignedUp = (shift.signUps || []).some(s => s.userId === currentUserId);

                            let statusColor = 'bg-green-600'; // Available
                            if (isFull) {
                                statusColor = 'bg-red-600'; // Full
                            } else if (currentSignUps > 0) {
                                statusColor = 'bg-indigo-600'; // Partially filled
                            }
                            
                            const statusText = `${currentSignUps}/${totalSlots} Slots`;

                            const interactionClass = isPast ? '' : 'cursor-pointer'; 
                            const hoverClass = isPast ? '' : 'hover:shadow-xl transition duration-100';

                            return `
                                <div data-shift-id="${shift.id}" 
                                     class="shift-entry p-1 rounded text-white text-xs font-medium shadow-md ${statusColor} ${hoverClass} ${interactionClass}"
                                     data-is-past="${isPast}">
                                    <span class="font-bold">${shift.time}</span> (${statusText})
                                    ${userIsSignedUp ? '<span class="ml-1 text-yellow-200">★</span>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

                calendarGrid.appendChild(cell);
            }

            document.querySelectorAll('.shift-entry').forEach(entry => {
                if (entry.getAttribute('data-is-past') !== 'true') {
                    entry.addEventListener('click', (event) => {
                        event.stopPropagation();
                        const shiftId = entry.getAttribute('data-shift-id');
                        openShiftDetailModal(shiftId);
                    });
                }
            });
        }

        // --- MODAL HANDLING ---

        function openShiftDetailModal(shiftId) {
            const flatShifts = Object.values(shiftsData).flat();
            const shift = flatShifts.find(s => s.id === shiftId);

            if (!shift) {
                showMessage("Shift details not found.", true);
                return;
            }
            
            const shiftDate = new Date(shift.date);
            shiftDate.setHours(0, 0, 0, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isShiftPast = shiftDate < today;
            
            // NEW: Multi-slot logic
            const currentSignUps = shift.signUps || [];
            const totalSlots = shift.totalSlots || 1;
            const isFull = currentSignUps.length >= totalSlots;
            
            const currentUserSignup = currentSignUps.find(s => s.userId === currentUserId);
            const userIsSignedUp = !!currentUserSignup;
            const userSignupId = currentUserSignup ? currentUserSignup.signupId : null;


            modalTitle.textContent = `Shift on ${shift.date}`;
            modalShiftInfo.innerHTML = `
                <p class="text-xl font-bold text-white">${shift.time}</p>
                <p class="text-lg text-indigo-300">${shift.role}</p>
            `;
            
            // Update Sign-Up List Area
            slotsCountEl.textContent = `${currentSignUps.length}/${totalSlots} slots`;
            signedUpListEl.innerHTML = currentSignUps.length > 0
                ? currentSignUps.map(s => `
                    <li class="p-2 bg-slate-700 rounded-lg flex justify-between items-center">
                        ${s.name} 
                        ${s.userId === currentUserId ? '<span class="text-yellow-400 font-bold text-sm">(You)</span>' : ''}
                    </li>
                `).join('')
                : '<li class="text-gray-400 italic">No one signed up yet.</li>';

            // Reset button actions and hide everything
            cancelSignUpButton.onclick = null;
            signUpButton.onclick = null;
            superCancelButton.onclick = null;
            adminDeleteButton.onclick = null; 
            
            filledInfoContainer.classList.remove('hidden'); 
            cancelSignUpButton.classList.add('hidden');
            superCancelButton.classList.add('hidden');
            adminDeleteButton.classList.add('hidden'); 
            document.getElementById('can-cancel-message').classList.add('hidden');
            signupFormContainer.classList.add('hidden');

            // --- Logic based on shift status ---

            if (isShiftPast) {
                // PAST SHIFT
                document.getElementById('can-cancel-message').textContent = 'This shift is in the past.';
                document.getElementById('can-cancel-message').classList.remove('hidden');
                
            } else if (userIsSignedUp) {
                // CURRENT USER IS SIGNED UP (Future Shift)
                cancelSignUpButton.classList.remove('hidden');
                document.getElementById('can-cancel-message').textContent = 'You are signed up for this shift. Cancel below if needed.';
                document.getElementById('can-cancel-message').classList.remove('hidden');

                cancelSignUpButton.onclick = async () => {
                    const success = await cancelUserSignUp(shiftId, userSignupId); 
                    if (success) closeDetailModal();
                };

            } else if (isFull) {
                 // SHIFT IS FULL BUT USER ISN'T SIGNED UP (Future Shift)
                document.getElementById('can-cancel-message').textContent = 'This shift is fully booked.';
                document.getElementById('can-cancel-message').classList.remove('hidden');

            } else {
                // SHIFT AVAILABLE (Future Shift)
                signupFormContainer.classList.remove('hidden');

                signUpButton.onclick = async () => {
                    const name = signUpNameInput.value.trim();
                    if (name) {
                        const success = await signUpForShift(shiftId, name);
                        if (success) closeDetailModal();
                    } else {
                        showMessage("Please enter your name to sign up.", true);
                    }
                };
            }
            
            // --- ADMIN OVERRIDES ---
            if (isAdmin) {
                // Admin can always delete the shift entirely
                adminDeleteButton.classList.remove('hidden');
                adminDeleteButton.onclick = async () => {
                    const success = await deleteShift(shiftId);
                    if (success) closeDetailModal();
                };

                // Admin button to clear ALL sign-ups
                if (currentSignUps.length > 0) {
                    superCancelButton.classList.remove('hidden');
                    superCancelButton.textContent = 'Admin: Clear ALL Sign-Ups (Make Available)';
                    superCancelButton.onclick = async () => {
                        const success = await adminClearAllSignUps(shiftId);
                        if (success) closeDetailModal();
                    };
                }
            }

            detailModal.classList.remove('hidden');
            detailModal.classList.add('flex');
        }

        function closeDetailModal() {
            detailModal.classList.add('hidden');
            detailModal.classList.remove('flex');
        }

        function openAddShiftModal() {
            if (!isAdmin) return;

            const today = new Date();
            const minDate = formatDate(today.getFullYear(), today.getMonth(), today.getDate());
            shiftDateInput.setAttribute('min', minDate);
            shiftDateInput.value = minDate.substring(0, 10);
            
            setTimeDropdowns(); 
            addModal.classList.remove('hidden');
            addModal.classList.add('flex');
        }

        function closeAddModal() {
            addModal.classList.add('hidden');
            addModal.classList.remove('flex');
            addShiftForm.reset();
        }


        // --- EVENT LISTENERS ---

        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        // Modal Controls
        openShiftModalBtn.addEventListener('click', openAddShiftModal);
        closeDetailModalBtn.addEventListener('click', closeDetailModal);
        closeAddModalBtn.addEventListener('click', closeAddModal);
        
        // Admin Login Controls
        openAdminLoginBtn.addEventListener('click', openAdminLoginModal);
        closeAdminModalBtn.addEventListener('click', closeAdminLoginModal);
        adminLoginForm.addEventListener('submit', handleAdminLogin);
        logoutButton.addEventListener('click', handleAdminLogout);
        
        // Form Submission for creating a new shift
        addShiftForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('shift-date').value;
            const startTime = shiftStartTimeSelect.value;
            const endTime = shiftEndTimeSelect.value;
            const time = `${startTime} - ${endTime}`; 
            const role = document.getElementById('shift-role').value.trim();
            const totalSlots = shiftSlotsInput.value; // NEW

            if (date && startTime && endTime && role && totalSlots) {
                if (startTime >= endTime) {
                    showMessage('Shift end time must be later than the start time.', true);
                    return;
                }
                if (Number(totalSlots) < 1) {
                    showMessage('Number of slots must be 1 or more.', true);
                    return;
                }
                const success = await createShift(date, time, role, totalSlots);
                if (success) closeAddModal();
            }
        });

        // Initial render on load
        window.onload = () => {
            updateAdminUI(); 
            if (db) {
                renderCalendar();
            } else {
                console.log("Waiting for Firebase to initialise...");
            }
        };

    </script>
</body>
</html>
