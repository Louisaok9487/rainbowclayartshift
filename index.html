<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Shift Scheduler</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base Dark Theme - Using richer slate tones */
        html { font-family: "Inter", sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #6366f1; /* Indigo-500 */ border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: #1e293b; /* Slate-800 */ }
        
        /* Mobile specific adjustments for calendar */
        @media (max-width: 640px) {
            .shift-entry {
                padding: 0.25rem !important;
                font-size: 0.6rem !important;
            }
            .h-28 { height: 7.5rem; }
        }

        /* Custom style for past dates */
        .past-day {
            background-color: #1e293b !important; /* Slate-800 */
            color: #64748b !important; /* Slate-500 */
            cursor: not-allowed;
        }

    </style>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <!-- Main Application Container -->
    <div id="app" class="max-w-6xl mx-auto">
        
        <!-- Header & Admin Controls -->
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-indigo-500">
            <h1 class="text-3xl font-extrabold text-indigo-400">Team Shift Scheduler</h1>
            <div id="admin-controls" class="space-x-4">
                <button id="admin-login-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    Admin Login
                </button>
                <button id="admin-logout-button" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    Admin Logout
                </button>
            </div>
        </header>

        <!-- Messaging Area (for alerts/confirmations) -->
        <div id="message-container" class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none p-4">
            <!-- Messages will be injected here -->
        </div>

        <!-- Calendar Navigation -->
        <div class="flex justify-between items-center mb-6 p-3 bg-slate-800 rounded-xl shadow-xl">
            <button id="prev-month" class="text-indigo-400 hover:text-indigo-300 transition duration-200 p-2 rounded-full hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
            </button>
            <h2 id="current-month" class="text-2xl font-semibold"></h2>
            <button id="next-month" class="text-indigo-400 hover:text-indigo-300 transition duration-200 p-2 rounded-full hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
            </button>
        </div>

        <!-- Calendar Grid -->
        <div class="grid grid-cols-7 gap-1 text-center font-medium text-indigo-300 mb-2">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
        <div id="calendar-grid" class="grid grid-cols-7 gap-1">
            <!-- Days will be inserted here -->
        </div>
        
        <!-- User ID Display (Mandatory for multi-user apps) -->
        <footer class="mt-8 text-center text-sm text-gray-500">
            Your User ID: <span id="user-id-display" class="font-mono text-gray-400">...</span>
        </footer>

    </div>

    <!-- Admin Login Modal -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-700 p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-6 text-white">Admin Login</h3>
            <form id="admin-login-form">
                <input type="password" id="admin-password" placeholder="Enter Admin Password" required class="w-full p-3 mb-4 bg-slate-800 border border-slate-600 rounded-lg text-white focus:ring-indigo-500 focus:border-indigo-500">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200">
                    Login
                </button>
            </form>
            <button onclick="closeLoginModal()" class="mt-4 text-sm text-indigo-400 hover:text-indigo-300 w-full">Close</button>
        </div>
    </div>

    <!-- Add Shift Modal (Admin Only) -->
    <div id="add-shift-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-700 p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6 text-white">Create New Shift</h3>
            <form id="add-shift-form">
                
                <div class="mb-4">
                    <label for="shift-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                    <input type="date" id="shift-date" required class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="shift-start-time" class="block text-sm font-medium text-gray-300 mb-1">Start Time</label>
                        <select id="shift-start-time" required class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="shift-end-time" class="block text-sm font-medium text-gray-300 mb-1">End Time</label>
                        <select id="shift-end-time" required class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="shift-role" class="block text-sm font-medium text-gray-300 mb-1">Role/Description</label>
                        <input type="text" id="shift-role" placeholder="e.g. Server, Barista, Manager" required class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white">
                    </div>
                    <div>
                        <label for="shift-slots" class="block text-sm font-medium text-gray-300 mb-1">Total Slots</label>
                        <input type="number" id="shift-slots" value="1" min="1" required class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white">
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200">
                    Create Shift
                </button>
            </form>
            <button onclick="closeAddModal()" class="mt-4 text-sm text-indigo-400 hover:text-indigo-300 w-full">Close</button>
        </div>
    </div>


    <!-- Shift Details & Sign Up Modal (All Users) -->
    <div id="signup-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-700 p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6 text-white">Shift Details</h3>
            
            <div id="shift-info" class="mb-6 p-4 bg-slate-800 rounded-lg">
                <p><span class="font-semibold text-indigo-300">Date:</span> <span id="modal-date"></span></p>
                <p><span class="font-semibold text-indigo-300">Time:</span> <span id="modal-time"></span></p>
                <p><span class="font-semibold text-indigo-300">Role:</span> <span id="modal-role"></span></p>
                <p><span class="font-semibold text-indigo-300">Slots:</span> <span id="modal-slots"></span></p>
            </div>

            <!-- List of Signed Up Users -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-2">Signed Up:</h4>
                <div id="signed-up-list" class="space-y-2 max-h-40 custom-scroll overflow-y-auto p-2 bg-slate-900 rounded-lg">
                    <!-- Users will be listed here -->
                </div>
            </div>

            <!-- Sign Up Form (Always visible for user to input name) -->
            <div id="sign-up-area">
                <div class="mb-4">
                    <label for="display-name-input" class="block text-sm font-medium text-gray-300 mb-1">Your Display Name</label>
                    <input type="text" id="display-name-input" placeholder="Enter name to appear on schedule" required class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button id="sign-up-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200 hidden">
                    Sign Up for this Shift
                </button>
                <button id="cancel-sign-up-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg transition duration-200 hidden">
                    Cancel My Sign Up
                </button>
            </div>
            
            <button onclick="closeSignUpModal()" class="mt-6 text-sm text-indigo-400 hover:text-indigo-300 w-full">Close</button>
        </div>
    </div>

    <!-- Global Modal Functions (Accessible to inline onclick handlers) -->
    <script>
        const loginModal = document.getElementById('login-modal');
        const addShiftModal = document.getElementById('add-shift-modal');
        const signUpModal = document.getElementById('signup-modal');
        const shiftDateInput = document.getElementById('shift-date'); // Reference for past date restriction

        // Define functions globally so they can be accessed by HTML inline 'onclick'
        function closeLoginModal() { loginModal.classList.add('hidden'); }
        function closeAddModal() { addShiftModal.classList.add('hidden'); }
        function closeSignUpModal() { signUpModal.classList.add('hidden'); }

        function openAddModal() { 
            // Set min date to today to prevent past shift creation in UI
            const today = new Date().toISOString().split('T')[0];
            shiftDateInput.min = today;
            shiftDateInput.value = today; // Set default value to today
            addShiftModal.classList.remove('hidden'); 
        }

        function openLoginModal() { loginModal.classList.remove('hidden'); }
        function openSignUpModal() { signUpModal.classList.remove('hidden'); }
    </script>


    <!-- Firestore and Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, deleteDoc, runTransaction, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Using the user-provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzGuxM-WXRFzkSLY16sutBF6qn57-tlsM",
            authDomain: "rcashift-2e40d.firebaseapp.com",
            projectId: "rcashift-2e40d",
            storageBucket: "rcashift-2e40d.firebasestorage.app",
            messagingSenderId: "903668836399",
            appId: "1:903668836399:web:ed5e464cc9264847763eda"
        };
        
        // Use the projectId as the identifier for Firestore pathing
        const appId = firebaseConfig.projectId; 

        let app;
        let db;
        let auth;
        let userId = 'loading...';
        let isAdmin = false;
        let currentYearMonth = new Date();
        let allShifts = {}; // Global store for shifts: { 'YYYY-MM-DD': [{...shift}, {...shift}], ... }
        let currentShiftDocId = null; // Used to track the shift being viewed/modified in the modal

        // --- Firebase Initialisation and Authentication ---
        setLogLevel('Debug');

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Set session persistence for the admin login
            setPersistence(auth, browserSessionPersistence);

            // Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // Sign in anonymously for all users since no custom token is available
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                }
                document.getElementById('user-id-display').textContent = userId;
                updateAdminUI();
                startShiftListener(); // Start listening for data once authenticated
                renderCalendar();
            });

        } catch (error) {
            console.error("Firebase initialisation error:", error);
            showMessage("Error initialising application. Check Firebase configuration.", true);
        }

        // --- Utility Functions ---

        /**
         * Shows a temporary message in a modal-like overlay.
         * @param {string} message The message to display.
         * @param {boolean} isError If true, displays as an error.
         */
        function showMessage(message, isError = false) {
            const container = document.getElementById('message-container');
            const colourClass = isError ? 'bg-red-600' : 'bg-green-600';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-xl shadow-2xl font-semibold text-white transition-all transform duration-300 ease-out ${colourClass} pointer-events-auto max-w-sm`;
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.classList.add('opacity-0', 'scale-90');
                messageDiv.addEventListener('transitionend', () => messageDiv.remove());
            }, 3000);
        }

        /**
         * Formats a Date object to YYYY-MM-DD string.
         * @param {Date} date 
         * @returns {string}
         */
        function formatDate(date) {
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0');
        }

        /**
         * Checks if a given date string is in the past.
         * @param {string} dateString YYYY-MM-DD
         * @returns {boolean} True if the date is strictly in the past.
         */
        function isPastDate(dateString) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
            const date = new Date(dateString);
            date.setHours(0, 0, 0, 0);
            return date.getTime() < today.getTime();
        }

        // --- Modals and UI State ---

        /**
         * Toggles admin view elements based on admin status.
         */
        function updateAdminUI() {
            const loginButton = document.getElementById('admin-login-button');
            const logoutButton = document.getElementById('admin-logout-button');

            if (isAdmin) {
                loginButton.classList.add('hidden');
                logoutButton.classList.remove('hidden');
            } else {
                loginButton.classList.remove('hidden');
                logoutButton.classList.add('hidden');
            }
            renderCalendar(); // Re-render calendar to update "Add Shift" buttons visibility
        }

        // --- Calendar Rendering ---

        /**
         * Renders the calendar grid for the current month.
         */
        function renderCalendar() {
            if (!db) return; // Wait for Firebase init

            const now = currentYearMonth;
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // Set the month display title
            document.getElementById('current-month').textContent = new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 (Sun) to 6 (Sat)
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            
            // Add blank cells for padding
            for (let i = 0; i < firstDayOfMonth; i++) {
                const blankDiv = document.createElement('div');
                blankDiv.className = 'p-2 h-28 bg-slate-800 rounded-lg';
                calendarGrid.appendChild(blankDiv);
            }
            
            // Add day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = formatDate(date);
                const dayShifts = allShifts[dateString] || [];
                
                const isPast = isPastDate(dateString); // 2. Check for past date
                const dayClass = isPast ? 'past-day' : 'bg-slate-700 hover:bg-slate-600 cursor-pointer';

                const dayDiv = document.createElement('div');
                dayDiv.className = `p-2 h-28 rounded-xl shadow-md transition duration-150 relative ${dayClass} flex flex-col`;
                
                dayDiv.innerHTML = `
                    <div class="text-lg font-bold mb-1">${day}</div>
                    <div class="flex-grow custom-scroll overflow-y-auto space-y-1">
                        ${dayShifts.map(shift => `
                            <div id="shift-${shift.id}" 
                                class="shift-entry p-1 bg-indigo-600 hover:bg-indigo-500 text-xs font-medium rounded-md shadow transition duration-100" 
                                data-doc-id="${shift.id}" data-date="${dateString}">
                                ${shift.role} (${(shift.signedUpUsers || []).length}/${shift.totalSlots})
                            </div>
                        `).join('')}
                    </div>
                `;

                // Add event listeners for viewing/signing up for shifts
                dayDiv.querySelectorAll('.shift-entry').forEach(shiftEl => {
                    shiftEl.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the day click event from firing
                        if (!isPast) { // Prevent interaction for past shifts
                           handleShiftClick(shiftEl.dataset.docId);
                        }
                    });
                });

                // Add "Add Shift" button for admins on current or future dates
                if (isAdmin && !isPast) { // 2. & 3. Only allow admin interaction on current/future dates
                    const addButton = document.createElement('button');
                    addButton.className = 'absolute bottom-2 right-2 bg-indigo-500 hover:bg-indigo-400 text-white p-1 rounded-full shadow-lg';
                    addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`;
                    addButton.onclick = (e) => {
                        e.stopPropagation();
                        // Set the date input in the modal to the selected day
                        document.getElementById('shift-date').value = dateString;
                        openAddModal();
                    };
                    dayDiv.appendChild(addButton);
                }

                calendarGrid.appendChild(dayDiv);
            }
        }

        /**
         * Handles the click event on a shift entry to display details/sign up modal.
         * @param {string} docId The Firestore document ID of the shift.
         */
        async function handleShiftClick(docId) {
            if (!userId) return showMessage("Please wait for authentication to complete.", true);

            currentShiftDocId = docId;
            // Get the shift data from the global store
            let shift = null;
            for (const date in allShifts) {
                const foundShift = allShifts[date].find(s => s.id === docId);
                if (foundShift) {
                    shift = foundShift;
                    break;
                }
            }

            if (!shift) {
                return showMessage("Shift details could not be found.", true);
            }
            
            // Populate modal info
            document.getElementById('modal-date').textContent = shift.date;
            document.getElementById('modal-time').textContent = shift.time;
            document.getElementById('modal-role').textContent = shift.role;
            document.getElementById('modal-slots').textContent = `${(shift.signedUpUsers || []).length} / ${shift.totalSlots}`;

            // Populate signed up list
            const listEl = document.getElementById('signed-up-list');
            const signedUpUsers = shift.signedUpUsers || []; // Use guaranteed array
            
            listEl.innerHTML = signedUpUsers.length > 0
                ? signedUpUsers.map(u => 
                    `<div class="flex justify-between items-center p-2 bg-slate-800 rounded-md">
                        <span class="text-white">${u.displayName}</span>
                        ${u.userId === userId ? '<span class="text-xs font-semibold text-indigo-400">(You)</span>' : ''}
                    </div>`
                ).join('')
                : `<div class="text-gray-400 p-2 text-center">No one signed up yet. Be the first!</div>`;

            // Check if user is already signed up
            const userIsSignedUp = signedUpUsers.some(u => u.userId === userId);
            const slotsAvailable = signedUpUsers.length < shift.totalSlots;

            const signUpButton = document.getElementById('sign-up-button');
            const cancelButton = document.getElementById('cancel-sign-up-button');
            const displayNameInput = document.getElementById('display-name-input');
            
            // 4. Pre-fill display name from localStorage if available
            const storedDisplayName = localStorage.getItem('shiftSchedulerDisplayName');
            if (storedDisplayName) {
                displayNameInput.value = storedDisplayName;
            } else {
                displayNameInput.value = '';
            }

            if (userIsSignedUp) {
                // User is signed up, show cancel button
                signUpButton.classList.add('hidden');
                cancelButton.classList.remove('hidden');
                displayNameInput.disabled = true;
            } else if (slotsAvailable) {
                // User is not signed up and slots are available, show sign up button
                signUpButton.classList.remove('hidden');
                cancelButton.classList.add('hidden');
                displayNameInput.disabled = false;
            } else {
                // No slots available, hide both
                signUpButton.classList.add('hidden');
                cancelButton.classList.add('hidden');
                displayNameInput.disabled = true;
                showMessage("Sorry, this shift is full.", true);
            }

            openSignUpModal();
        }

        // --- Firestore Operations ---

        /**
         * Gets the Firestore path for the public shifts collection.
         */
        function getShiftsCollectionPath() {
            // Path structure: /artifacts/{appId}/public/data/shifts
            return `artifacts/${appId}/public/data/shifts`;
        }

        /**
         * Sets up a real-time listener for all shifts in the current and future months.
         */
        function startShiftListener() {
            const path = getShiftsCollectionPath();
            const shiftsColRef = collection(db, path);
            
            // Start listener from the beginning of the current month
            const firstDayOfMonth = formatDate(new Date(currentYearMonth.getFullYear(), currentYearMonth.getMonth(), 1));

            // Query: filter by shifts starting from the current month's first day
            const q = query(shiftsColRef, where('date', '>=', firstDayOfMonth));

            onSnapshot(q, (snapshot) => {
                const newShifts = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const dateKey = data.date;
                    if (!newShifts[dateKey]) {
                        newShifts[dateKey] = [];
                    }
                    
                    // FIX: Ensure signedUpUsers exists and is an array, defaulting to []
                    const shiftData = { 
                        id: doc.id, 
                        ...data, 
                        signedUpUsers: data.signedUpUsers || [] 
                    };
                    
                    newShifts[dateKey].push(shiftData);
                });
                allShifts = newShifts;
                renderCalendar(); // Re-render every time data changes
            }, (error) => {
                console.error("Error listening to shifts:", error);
                showMessage("Could not fetch real-time data.", true);
            });
        }

        /**
         * Creates a new shift document in Firestore.
         */
        async function createShift(date, time, role, totalSlots) {
            if (!isAdmin) {
                showMessage("You must be an admin to create a shift.", true);
                return false;
            }

            const path = getShiftsCollectionPath();
            const newShiftRef = doc(collection(db, path));
            
            try {
                await setDoc(newShiftRef, {
                    date: date,
                    time: time,
                    role: role,
                    totalSlots: Number(totalSlots),
                    signedUpUsers: [], // Array of {userId: string, displayName: string}
                    createdBy: userId,
                    createdAt: new Date().toISOString()
                });
                showMessage(`Shift created for ${date} in role: ${role}.`);
                return true;
            } catch (e) {
                console.error("Error creating shift:", e);
                showMessage("Failed to create shift. Check permissions.", true);
                return false;
            }
        }

        /**
         * Signs the current user up for a specific shift.
         * @param {string} docId The ID of the shift document.
         * @param {string} displayName The display name of the user.
         */
        async function signUpForShift(docId, displayName) {
            const path = getShiftsCollectionPath();
            const shiftRef = doc(db, path, docId);
            
            // 4. Save display name to localStorage for future use
            localStorage.setItem('shiftSchedulerDisplayName', displayName);

            const userEntry = { 
                userId: userId, 
                displayName: displayName 
            };

            try {
                // Use a transaction to ensure atomic update and slot check
                await runTransaction(db, async (transaction) => {
                    const shiftDoc = await transaction.get(shiftRef);
                    if (!shiftDoc.exists()) {
                        throw new Error("Shift does not exist!");
                    }
                    const data = shiftDoc.data();
                    
                    // Use guaranteed array for checking length
                    const currentUsers = data.signedUpUsers || []; 

                    if (currentUsers.length >= data.totalSlots) {
                        throw new Error("Shift is already full.");
                    }
                    
                    if (currentUsers.some(u => u.userId === userId)) {
                        throw new Error("You are already signed up for this shift.");
                    }

                    // Append the new user object
                    transaction.update(shiftRef, {
                        signedUpUsers: arrayUnion(userEntry)
                    });
                });

                showMessage("You have successfully signed up for the shift!");
                closeSignUpModal();

            } catch (e) {
                console.error("Error signing up:", e);
                // Custom error messages
                const msg = e.message.includes("full") || e.message.includes("already signed up") 
                    ? e.message : "Failed to sign up for shift.";
                showMessage(msg, true);
            }
        }

        /**
         * Removes the current user from a specific shift.
         * @param {string} docId The ID of the shift document.
         */
        async function cancelSignUp(docId) {
            const path = getShiftsCollectionPath();
            const shiftRef = doc(db, path, docId);

            // Find the user entry to remove (requires the exact object that was saved)
            const shiftDoc = await getDoc(shiftRef);
            if (!shiftDoc.exists()) {
                 return showMessage("Shift does not exist!", true);
            }
            const signedUpUsers = shiftDoc.data().signedUpUsers || []; // Use guaranteed array
            const userEntryToRemove = signedUpUsers.find(u => u.userId === userId);

            if (!userEntryToRemove) {
                 return showMessage("You are not currently signed up for this shift.", true);
            }

            try {
                await updateDoc(shiftRef, {
                    signedUpUsers: arrayRemove(userEntryToRemove)
                });
                showMessage("You have cancelled your sign up.");
                closeSignUpModal();
            } catch (e) {
                console.error("Error cancelling sign up:", e);
                showMessage("Failed to cancel sign up. Please try again.", true);
            }
        }


        // --- Admin Authentication Logic ---

        const ADMIN_PASSWORD = "1234"; // IMPORTANT: Change this in a real application

        async function handleAdminLogin(password) {
            if (password === ADMIN_PASSWORD) {
                // For demonstration, we simply set the isAdmin flag and re-authenticate as admin.
                // In a real scenario, you'd use Firebase Custom Claims or a dedicated admin service.
                isAdmin = true;
                updateAdminUI();
                showMessage("Admin access granted.");
                closeLoginModal();
            } else {
                showMessage("Incorrect password. Please try again.", true);
            }
        }

        function handleAdminLogout() {
            isAdmin = false;
            updateAdminUI();
            showMessage("Admin access revoked.");
        }


        // --- Event Listeners and Initial Setup ---

        const adminLoginButton = document.getElementById('admin-login-button');
        const adminLoginForm = document.getElementById('admin-login-form');
        const logoutButton = document.getElementById('admin-logout-button');
        const addShiftForm = document.getElementById('add-shift-form');
        const shiftStartTimeSelect = document.getElementById('shift-start-time');
        const shiftEndTimeSelect = document.getElementById('shift-end-time');
        const shiftSlotsInput = document.getElementById('shift-slots');
        const signUpButton = document.getElementById('sign-up-button');
        const cancelButton = document.getElementById('cancel-sign-up-button');
        const displayNameInput = document.getElementById('display-name-input');


        // Setup time options for shift creation
        const times = Array.from({ length: 24 * 4 }, (_, i) => {
            const hour = Math.floor(i / 4);
            const minute = (i % 4) * 15;
            const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            return `<option value="${time}">${time}</option>`;
        }).join('');
        shiftStartTimeSelect.innerHTML = times;
        shiftEndTimeSelect.innerHTML = times;


        // Calendar Navigation
        document.getElementById('prev-month').addEventListener('click', () => {
            currentYearMonth.setMonth(currentYearMonth.getMonth() - 1);
            renderCalendar();
            startShiftListener(); // Restart listener for new month range
        });

        document.getElementById('next-month').addEventListener('click', () => {
            currentYearMonth.setMonth(currentYearMonth.getMonth() + 1);
            renderCalendar();
            startShiftListener(); // Restart listener for new month range
        });


        // Admin Login Listener
        adminLoginButton.addEventListener('click', openLoginModal);
        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            handleAdminLogin(password);
            adminLoginForm.reset();
        });
        logoutButton.addEventListener('click', handleAdminLogout);
        
        // Form Submission for creating a new shift
        addShiftForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('shift-date').value;
            const startTime = shiftStartTimeSelect.value;
            const endTime = shiftEndTimeSelect.value;
            const time = `${startTime} - ${endTime}`; 
            const role = document.getElementById('shift-role').value.trim();
            const totalSlots = shiftSlotsInput.value;

            if (date && startTime && endTime && role && totalSlots) {
                // 3. Admin cannot create shift in the past date check
                if (isPastDate(date)) {
                    showMessage('Cannot create shifts in the past.', true);
                    return;
                }

                if (startTime >= endTime) {
                    showMessage('Shift end time must be later than the start time.', true);
                    return;
                }
                if (Number(totalSlots) < 1) {
                    showMessage('Number of slots must be 1 or more.', true);
                    return;
                }
                const success = await createShift(date, time, role, totalSlots);
                if (success) closeAddModal();
            }
        });

        // Sign Up / Cancel Buttons
        signUpButton.addEventListener('click', () => {
            const displayName = displayNameInput.value.trim();
            if (!displayName) {
                showMessage("Please enter a display name to sign up.", true);
                displayNameInput.focus();
                return;
            }
            if (currentShiftDocId) {
                signUpForShift(currentShiftDocId, displayName);
            }
        });

        cancelButton.addEventListener('click', () => {
            if (currentShiftDocId) {
                cancelSignUp(currentShiftDocId);
            }
        });


        // Initial render on load
        window.onload = () => {
            updateAdminUI(); 
            if (db) {
                renderCalendar();
            } else {
                console.log("Waiting for Firebase to initialise...");
            }
        };

    </script>
</body>
</html>
